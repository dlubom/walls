

                      CMAP 16.1 User Instructions
                                   by
                              Robert Thrun
                             December, 1992

CMAP 16 is Copyrighted (C) 1986-1992 by Robert Thrun. See the legal sec-
tion below for a statement of distribution restrictions.

Brief Description
------------------

CMAP 16 is a microcomputer program to process cave survey data. Previous 
versions were run on mainframe computers. CMAP 16 has been extensively 
revised to run on microcomputers. The user may use any editor to prepare 
data files with cave survey data. Many different data units are accep-
table. CMAP can do a least-squares adjustment of closure networks and 
provide error statistics. The coordinates of survey stations are written 
to a file for further processing by graphics programs. The design of the 
program emphasizes speed and simplicity. CMAP should run under any ver-
sion of MS-DOS. 

In this documentation I will assume that the user is familiar with MS-
DOS, knows how to run a program, and knows how to specify file names. In 
the description of commands, the parts shown in uppercase are keywords 
that must be spelled just as shown, although they may be typed in lower-
case. For the parts in lowercase, the user must provide the proper file 
name or value.

Legal
-----

CMAP 16 is Copyrighted (C) 1986-1992 by Robert Thrun.  All rights to
the source code and all commercial rights are reserved.  The compiled,
executable program and its accompanying files may be distributed and
used freely, provided it is not sold or used in a commercial
enterprise. The restriction against sales particularly applies to
distributors of public domain and shareware programs. It may otherwise
be used and shared by cavers.

Portions of CMAP 16 are from earlier versions of CMAP. These versions 
and the code in them are copyrighted. The related CQUAD programs and 
SYMBOL routines are placed in the public domain and anybody may do what 
they want with them. The PGD Printer Graphics Driver programs are copy-
righted and have the same restrictions as CMAP 16.

Versions
-------- 

A system of suffixes is used to indicate different versions of the 
program. The versions differ in the number of stations that the program 
can handle, and on whether an 80x87 coprocessor or 80386 (or later) 
processor is required.  The free memory needed is given in K, where 1K
= 1024 bytes.  The amount shown is for a run with one input file.  Each
level of input file nesting requires 1K more memory.

                                                  Free
                           8087    8087   80386  Memory
       Version  Capacity   Used  Needed  Needed  Needed
          A        1024      No     No      No    112K+
          B        1024     Yes    Yes      No    108K+
          C       10000      No     No      No    549K+
          D       10000     Yes    Yes      No    544K+
         386      32000     Yes    Yes     Yes   1.6 Meg extended memory

I considered making versions of CMAP that will make use of a math
coprocessor if one is available and will emulate the coprocessor if one
is not available.  After doing some benchmarking, I decided that I
would be doing nobody a favor by making such versions available.

Other Files in the Package
--------------------------

    CMAP16.DOC  -- This documentation file.
    PF.DAT ------- Sample data file. Run with the command:  CMAP PF.DAT
    ANGTEST.EXE -- Program for testing various forms of angle data
                   conversion.
    DISTTEST.EXE - Program for testing various forms of distance data.
    PERCENT.EXE -- Used to convert older data files to ones with % sign.
    CMACRO.EXE --- Converts CMAP output to AcroSpin input.
    NAMSQZ.EXE --- Removes leading and embedded blanks from station
                   names and converts them to uppercase.

Invoking CMAP
-------------

To run CMAP give one of the two following commands from the operating 
system:

   CMAP
   CMAP filename.ext

If the first form of the command is used, the program will ask for the 
name of a file to be read. The named file should have CMAP commands, 
comments, survey data, or any combination of these. Drive identifiers 
and paths may be used as part of the file name. 

CMAP Comments
-------------

If the first column of a line is not blank, that line is either a 
comment or command. CMAP compares the first word on a line, from column 
1 to the first blank, with the list of command keywords. If the first 
word does not match one of the commands, then that line is a comment. 
The program does not do anything with comments. Comments may be put into 
the data file to identify the data or to retain a record of various 
information along with the survey data. A description of the areas 
surveyed, survey dates, surveyors names, and the instruments used may be 
kept on comments interspersed with the data.

*** Isn't this a little too lax? If a keyword is misspelled, or a
    leading blank is omitted on a shot line, wouldn't it be easily
    overlooked? I'm considering the idea of separate comment and
    directive prefix characters, with all else treated as survey data.
    You could provide the option of generating an "ERRORS.TXT" file
    highlighting any lines that don't meet the stricter formatting
    guidelines.

CMAP Commands
-------------

The CMAP commands currently implemented are:

   ADJUST
   DECLIN
   DEFINE
   INCLUDE
   NOTE
   STOP
   SUBTOTAL
   TITLE
   WRITE

Other commands not yet implemented are:

   HELP
   PAGE
   PLOT

The unimplemented commands will be treated as comments. Future versions 
of CMAP will use them as commands. 

The commands may be given in any combination of uppercase and lowercase 
letters. Some of the commands may be followed by a series of secondary 
fields with additional keywords, file names, or data. The secondary 
fields must be separated by blanks. If a field is not present or if a 
value in a field is not recognized, the default value will be used.

ADJUST has the format:
------

   ADJUST  weighting  table-type  table-filename

The weighting may be one of four possible methods:

   NUMBER --- The string weight is the reciprocal of the number of 
              survey shots in the string.
   LENGTH --- The string weight is the reciprocal of the length of the 
              survey string.
   STDDEV --- The string weight is the reciprocal of the standard 
              deviation of the survey string.
   VARIANCE - The string weight is the reciprocal of the variance of 
              the string. This is the default value.

Note:  All but the varaince weighting is due to be phased out.

There are two options for the table type:

   ENDS - The adjustment table will have the beginning and end stations 
          of the adjusted strings. This is the default.
   FULL - All the stations in an adjusted string will be listed. This 
          generates a larger table.

If no file name is specified for the adjustment table, the name will be 
"ADJUST.TBL" on the default drive.

The options for weighting type and table type and the filename may be in 
any order. If you want a file that is named the same as one of the 
options, add a period to the filename.

When an ADJUST command is encountered in the input stream, a closure 
adjustment is made.

To get the variance and standard deviation of the survey string, several 
assumptions are made. The errors are assumed to be random. On a given 
survey shot, the variance of the expected errors is the same in all 
directions. The errors in the angle measurements, both horizontal and 
vertical, have a uniform distribution of plus or minus 0.5 degrees. The 
combined errors of distance measurement and station position have a 
standard deviation of 0.2 feet. The assumptions about the errors may or 
may not be approximately correct. The absolute values of the factors 
that contribute to the assumed survey error are not as important as the 
relative values. The adjustments are done according to the ratios of 
standard deviation or variance between various strings. The ratio of 
adjustment to probable error provides a basis for comparing the amount 
of adjustment in strings of different sizes. 

A connectivity table is generated as a byproduct of the adjustment 
process. The connectivity of a station is the number of survey shots 
that connect to the station. The number of stations given in the connec-
tivity table is not the same as the total number of stations in the 
program. When a closure is made, we get a station with the same name as 
previously encountered, but with different coordinates. The connectivity 
table does not include the additional appearances of a station.


DECLIN has the format:
------

     DECLIN angle

DECLIN specifies the declination correction that will be added to the
azimuth angles on all shots after the DECLIN command. DECLIN should be
followed by an angle value. The angle is in the same format as in the
survey data (see below). There is currently no indication on the output
that any declination correction has been made.


DEFINE has the format:
------

     DEFINE  station-name  x-coordinate  y-coordinate  z-coordinate

The DEFINE command provides the coordinates for a constrained station. 
The station name and coordinates must appear in the order shown. Every 
survey should have at least one station, the initial station, DEFINEd.
If there is no DEFINE, the FROM station on the first shot will be given
the coordinates of (0,0,0). Additional DEFINEd stations may be surface
survey points or radio locations that the survey must be adjusted to
conform to.

The station name and coordinates are in the same format as station names 
and distances are in the survey data. However, since spaces are used as 
separators, no spaces are allowed in a station name or coordinate field. 
If a coordinate value is not given, it will default to zero. 


INCLUDE has the format:
-------

     INCLUDE  filename

The file named on the INCLUDE command will be made part of the input 
stream, just as if the file had been inserted at the point of the 
INCLUDE command. The filename must conform to the usual MS-DOS rules. A 
drive or path may be specified as part of the file name. Path names are 
supported. A maximum of 14 input files may be open at any one time.
When the end of the INCLUDEd file is encountered, the file is closed,
and the program reverts to the previous file level. If the the end of
all input files is reached, the program will prompt the user for
console input.


NOTE has the format:
----

     NOTE station_name  40-character note

The NOTE command attaches a note or comment to the named station.  The
station name can't have any embedded blanks in it.  The notes are
written on the output file near every appearance of the station name.
If the output file is in shot format, the note follows the coordinates
on the same line.  If the output file is in shot format, the note is
before the line with the station name and coordinates.  The notes may
be anywhere in the input stream before the Write command.

STOP
----

This is the normal way of stopping the program. If there is no STOP 
command, the program will ask for console input. Any input, including a 
STOP or INCLUDE command, may be entered from the console.


SUBTOTAL has the format:
--------

     SUBTOTAL any optional identifying text

The SUBTOTAL command writes to the console. It displays the text 
following the keyword and gives the number of survey stations, survey 
length, time since the previous SUBTOTAL; and totals since the program 
started executing. The time includes everything, including the time the 
program is waiting for the user to type some input at the console.


TITLE has the format:
-----

     TITLE  40-character title

This specifies a title that will be written on the station coordinate
output file.  This command may be anywhere before the WRITE command.


WRITE has the format:
-----

     WRITE   filename   [PAGE]  [SHOT]

This writes a table with all the station names and coordinates to a
file. The arguments may be in any order.  If there has been no closure
adjustment, the closure errors will be indicated in the table.  If no
file name is specified, "SURVEY.XYZ" on the default drive will be used.
If a file with the specified name already exists, it will be
overwritten with no warning.  Device names, such as PRN, are valid file
names.

All the data will be written on one file. This may pose a limitation on 
the size of the survey that can be processed if the space on the output
disk drive is limited.

The keywords "SHOT" and "PAGE" control the format of the output.  The
default output is station format with no page breaks or page numbers.

The station output format has the station name, its coordinates, and
what station it is connected to. It consists of the following items:

   - Name of the survey station. The names are converted to uppercase,
     left justified, and have embedded blanks removed.
   - X, Y, and Z coordinates of the survey station, in feet.
   - Number of the previous station to which the current station is 
     connected. 
   - Station number where the name of the current station first      
     appeared. If this is not a closure station, the number will be 
     the current station number.
   - Shot type
   - Note, up to 40 characters.

The station output is written with a FORTRAN format (A6, 2F9.1, F8.1,
2I5, 1X, A1, 1X, A).

The station numbers are gotten from the order in which the stations were 
given to CMAP. The first station is number 1, the second station is 
number 2, etc. The station names are independent from the station 
numbers, even if the names consist of all numerals. The numbers are 
omitted to save space. They could be gotten by counting stations or 
lines of output.

The shot output format has the OLD station of a FROM-TO pair, the NEW
station, the dX, dY, dZ components from the old station to the new
station, and the coordinates of the new station.  Each OLD-NEW line is
independent of the other lines.  

The closure error will be reported on the line just after the second and 
later appearances of a station name. The closure error is measured from 
the first appearance of the station name to the most recent appearance. 

All formats have headings at the top of the columns of names and
numbers.  If the PAGE option is chosen, the headings will be repeated
every 60 lines, along with formfeed characters and page numbers.

Distance totals and subtotals are reported after the station coordinates. 



Survey Data Format
------------------

The first column of a survey data input line must be blank. This is how 
CMAP distinguishes between data and comments or commands. The survey 
data must be located in fields that cover particular columns. You should 
have an editor that tells you what column the cursor is in. The fields 
are as follows:

  Columns    Data
  -------    ----
       1     must be blank, indicates this is survey data
    2 -7     FROM station name
    9-14     TO station name
   16-22     distance
      23     survey shot type
   24-33     azimuth
      35     T indicates transit elevation, zero straight up
   37-46     elevation
   48-52     height above FROM station
   54-58     height above TO station
   59-60     taping method
             blank - instrument to target assumed
             HZ - Horizontal taping
             IT - Instrument to Target
             ST - Station to Target
             IS - Instrument to Station
             SS - Station to Station
   
CMAP removes spaces from station names, left justifies them, and con-
verts them to uppercase. At least one station of a FROM-TO pair must 
have been previously encountered. If one of the station fields is blank, 
CMAP will use the previous station, allowing the user to type in only 
one station name on each shot. This feature can be dangerous if the 
station order is changed. 

Within the distance and angle fields, almost any reasonable notation 
will be interpreted properly. So will a great many unreasonable nota-
tions. The ANGTEST and DISTTEST programs were written during the program 
development for checking the units conversion and are provided so the 
CMAP user may do the same. Very little checking for illegal data is 
done, and there are no error messages when illegal data is encountered. 
The scanning and conversion usually stops at an illegal character.

Examples of legitimate distance data are:
     5                 5 feet
      29.3             29.3 feet
     8   3             8 feet, 3 inches
      32F 7.5          32 feet, 7.5 inches
     11.7 M            11.7 meters
     14 M6             14.6 meters
        15I            15 inches
     8.5Y              8.5 yards

Examples of legitimate angle data are:
     11                11 degrees
        247.           247 degrees
     15 30             15 degrees, 30 minutes
     315 D 20          315 degrees, 20 minutes
     27 7 36.1         27 degrees, 7 minutes, 36.1 seconds
     19.25D            19.25 degrees
      -45              minus 45 degrees
     +  1              plus 1 degree
     N3E               north, 3 degrees east
     S 31.5 W          south, 31.5 degrees west
     46.0 G            46 grads
     2430M             2430 mils (US)
     5600 F            5600 mils (French)
     -12.0%            minus 12 percent (grade)

The survey shot type may be any of the printing ASCII characters plus 
DEL. It may be used to identify different types of surveys, such as 
surface surveys or resurveys. The subtotals of the shot types are 
reported after the coordinate table generated by a WRITE command.

Earlier versions of CMAP used a P to designate percentage grade. The 
letter P was used because there was no percent sign on a keypunch. 
However, there is a percent sign on all microcomputers. The PERCENT 
program will convert a P in the elevation field to a % sign. PERCENT 
does not support pathnames.

Overview
--------

A rough outline of the input data arrangement is as follows:

     DEFINE sta1 x y z         first station coordinates
      . . .
      survey data
      . . .
     WRITE file1               unadjusted coordinates before ADJUST
     ADJUST
     WRITE file2               adjusted coordinates after ADJUST
     STOP

Post Processing
---------------

As of this writing, the only way of getting plots on paper is to use the 
file produced by a WRITE statement as input to CQUAD. CQUAD, in turn, 
writes a file that is input for PGD, the Printer Graphics Driver.

Known Bugs
----------

Some of the strings that connect cutblocks are reported as being 
adjusted when they should have not been adjusted at all. They have 
nearly zero adjustment. Ignore them; the adjustment is due to roundoff.


Changes from CMAP 15
--------------------

If there is no DEFINE statement, the FROM station of the first FROM-TO
pair will default to (0, 0, 0).  

The ROTATE command has been eliminated as being best suited for a
graphics program.

There is no longer a declination field on every data line.  Use the
DECLIN command to set the declination correction for groups of shots.

The maximum nesting level of INCLUDE files has been increased.

The program will take distances in feet, inches, and decimals of
inches.

The program will take angles in degrees, minutes, and decimals of
minutes, or in degrees, minutes, seconds, and decimals of seconds.

There is a progress indicator while doing closure adjustment.

The TITLE command has been implemented.

The NOTE command has been implemented and notes have been added to the
coordinate output.  The storage of NOTEs is responsible for the
increased memory requirements.

A three line heading has been added to the coordinate output produced
by the WRITE command.

The WRITE command has options for page format and shot format for the
coordinates. 

VARIANCE is the default option for weighting for adjustment.

The 386 version will get along with most memory managers.
