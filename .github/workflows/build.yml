# GitHub Actions CI/CD for Walls Cave Survey Software
# Requires Windows runner with Visual Studio

name: Build Walls

on:
  push:
    branches: [master, main]
    tags: ['v*']
  pull_request:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration'
        required: true
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug
          - Release_XP
          - Debug_XP
      platform:
        description: 'Build platform'
        required: true
        default: 'x86'
        type: choice
        options:
          - x86
          - x64

env:
  SOLUTION_PATH: Walls32/Walls.sln
  WALLSMAP_SOLUTION_PATH: WallsMap/WallsMap.sln

jobs:
  # ==============================================================================
  # WALLS32 BUILD
  # ==============================================================================
  build-walls:
    runs-on: windows-latest
    strategy:
      matrix:
        configuration: [Release]
        platform: [x86]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fix project paths
        run: |
          # Copy props files to Walls32/ where projects expect them
          Copy-Item -Path "vs_version.props" -Destination "Walls32/vs_version.props"
          Copy-Item -Path "zlib.props" -Destination "Walls32/zlib.props"

          # Copy inc/ and lib/ directories to Walls32/ where vs_version.props expects them
          # (WorkINC=$(SolutionDir)inc, WorkLIB=$(SolutionDir)lib)
          if (Test-Path "inc") {
            Write-Host "Copying inc/ to Walls32/inc/"
            Copy-Item -Path "inc" -Destination "Walls32/inc" -Recurse -Force
          }
          if (Test-Path "lib") {
            Write-Host "Copying lib/ to Walls32/lib/"
            Copy-Item -Path "lib" -Destination "Walls32/lib" -Recurse -Force
          }

          # Copy expatlib to Walls32/ where wallsvg expects it ($(WorkDIR)expatlib_2010-10-10)
          if (Test-Path "expatlib_2010-10-10") {
            Write-Host "Copying expatlib_2010-10-10/ to Walls32/"
            Copy-Item -Path "expatlib_2010-10-10" -Destination "Walls32/expatlib_2010-10-10" -Recurse -Force
          }

          # Copy zlib-1.2.8 to Walls32/ where zlib.props expects it ($(SolutionDir)\zlib-1.2.8)
          if (Test-Path "zlib-1.2.8") {
            Write-Host "Copying zlib-1.2.8/ to Walls32/"
            Copy-Item -Path "zlib-1.2.8" -Destination "Walls32/zlib-1.2.8" -Recurse -Force
          }

          # Checkout is at D:\a\walls\walls\
          # Solution at D:\a\walls\walls\Walls32\Walls.sln references ..\..\lib
          # That resolves to D:\a\walls\lib (one level up from repo)
          $parentDir = Split-Path -Parent (Get-Location)  # D:\a\walls

          # Copy library folders to expected location
          $libs = @("expatlib_2010-10-10", "pcrelib", "gziplib")
          foreach ($lib in $libs) {
            $src = Join-Path (Get-Location) $lib
            $dst = Join-Path $parentDir $lib
            if (Test-Path $src) {
              Write-Host "Copying $lib to $dst"
              Copy-Item -Path $src -Destination $dst -Recurse -Force
            } else {
              Write-Host "Warning: $lib not found in repo"
            }
          }

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2

      - name: Install NASM
        run: |
          choco install nasm -y --no-progress
          echo "C:\Program Files\NASM" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify NASM
        run: nasm --version

      - name: Download OpenGL headers
        run: |
          $sdkPath = "C:\Program Files (x86)\Windows Kits\10\Include"
          $sdkDirs = Get-ChildItem -Path $sdkPath -Directory | Sort-Object Name -Descending | Select-Object -First 1
          if ($sdkDirs) {
            $glPath = "$($sdkDirs.FullName)\um\gl"
            $khrPath = "$($sdkDirs.FullName)\um\KHR"

            if (-not (Test-Path $glPath)) {
              New-Item -ItemType Directory -Force -Path $glPath | Out-Null
            }
            if (-not (Test-Path $khrPath)) {
              New-Item -ItemType Directory -Force -Path $khrPath | Out-Null
            }

            Write-Host "Downloading OpenGL headers to $glPath"
            Invoke-WebRequest -Uri "https://www.khronos.org/registry/OpenGL/api/GL/glext.h" -OutFile "$glPath\glext.h"
            Invoke-WebRequest -Uri "https://www.khronos.org/registry/OpenGL/api/GL/wglext.h" -OutFile "$glPath\wglext.h"
            Invoke-WebRequest -Uri "https://www.khronos.org/registry/EGL/api/KHR/khrplatform.h" -OutFile "$khrPath\khrplatform.h"
          }

      - name: Restore NuGet packages
        run: nuget restore ${{ env.SOLUTION_PATH }}
        continue-on-error: true

      - name: Build Walls32
        run: |
          # First pass - builds libraries (may have link errors, that's expected)
          msbuild ${{ env.SOLUTION_PATH }} `
            /p:Configuration=${{ matrix.configuration }} `
            /p:Platform=${{ matrix.platform }} `
            /p:PlatformToolset=v143 `
            /m `
            /verbosity:minimal `
            /p:ContinueOnError=true || true

          # Second pass - now all libs are built, linking should succeed
          msbuild ${{ env.SOLUTION_PATH }} `
            /p:Configuration=${{ matrix.configuration }} `
            /p:Platform=${{ matrix.platform }} `
            /p:PlatformToolset=v143 `
            /m `
            /verbosity:minimal

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: walls-${{ matrix.configuration }}-${{ matrix.platform }}
          path: |
            Walls32/bin/*.exe
            Walls32/bin/*.dll
          retention-days: 7

  # ==============================================================================
  # WALLSMAP BUILD (manual)
  # ==============================================================================
  build-wallsmap:
    runs-on: windows-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fix project paths
        run: |
          Copy-Item -Path "vs_version.props" -Destination "Walls32/vs_version.props" -ErrorAction SilentlyContinue
          Copy-Item -Path "vs_version.props" -Destination "WallsMap/vs_version.props" -ErrorAction SilentlyContinue
          Copy-Item -Path "zlib.props" -Destination "Walls32/zlib.props" -ErrorAction SilentlyContinue
          Copy-Item -Path "zlib.props" -Destination "WallsMap/zlib.props" -ErrorAction SilentlyContinue
          $parentDir = Split-Path -Parent (Get-Location)
          $libs = @("expatlib_2010-10-10", "pcrelib", "gziplib")
          foreach ($lib in $libs) {
            $src = Join-Path (Get-Location) $lib
            $dst = Join-Path $parentDir $lib
            if (Test-Path $src) {
              Copy-Item -Path $src -Destination $dst -Recurse -Force
            }
          }

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2

      - name: Install NASM
        run: |
          choco install nasm -y --no-progress
          echo "C:\Program Files\NASM" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Download OpenGL headers
        run: |
          $sdkPath = "C:\Program Files (x86)\Windows Kits\10\Include"
          $sdkDirs = Get-ChildItem -Path $sdkPath -Directory | Sort-Object Name -Descending | Select-Object -First 1
          if ($sdkDirs) {
            $glPath = "$($sdkDirs.FullName)\um\gl"
            $khrPath = "$($sdkDirs.FullName)\um\KHR"

            if (-not (Test-Path $glPath)) {
              New-Item -ItemType Directory -Force -Path $glPath | Out-Null
            }
            if (-not (Test-Path $khrPath)) {
              New-Item -ItemType Directory -Force -Path $khrPath | Out-Null
            }

            Invoke-WebRequest -Uri "https://www.khronos.org/registry/OpenGL/api/GL/glext.h" -OutFile "$glPath\glext.h"
            Invoke-WebRequest -Uri "https://www.khronos.org/registry/OpenGL/api/GL/wglext.h" -OutFile "$glPath\wglext.h"
            Invoke-WebRequest -Uri "https://www.khronos.org/registry/EGL/api/KHR/khrplatform.h" -OutFile "$khrPath\khrplatform.h"
          }

      - name: Restore NuGet packages
        run: nuget restore ${{ env.WALLSMAP_SOLUTION_PATH }}
        continue-on-error: true

      - name: Build WallsMap
        run: |
          msbuild ${{ env.WALLSMAP_SOLUTION_PATH }} `
            /p:Configuration=Release `
            /p:Platform=x86 `
            /p:PlatformToolset=v143 `
            /m `
            /verbosity:minimal

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wallsmap-release-x86
          path: |
            WallsMap/Release/*.exe
            WallsMap/Release/*.dll
          retention-days: 7

  # ==============================================================================
  # RELEASE (on tags)
  # ==============================================================================
  release:
    runs-on: windows-latest
    needs: build-walls
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: walls-Release-x86
          path: release-files

      - name: Create release archive
        run: |
          $tag = "${{ github.ref_name }}"
          Compress-Archive -Path "release-files/*" -DestinationPath "Walls-$tag.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: Walls-*.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
