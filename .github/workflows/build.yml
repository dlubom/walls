# GitHub Actions CI/CD for Walls Cave Survey Software
# Requires Windows runner with Visual Studio

name: Build Walls

on:
  push:
    branches: [master, main, installer]
    tags: ['v*']
  pull_request:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration'
        required: true
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug
          - Release_XP
          - Debug_XP
      platform:
        description: 'Build platform'
        required: true
        default: 'x86'
        type: choice
        options:
          - x86
          - x64

env:
  SOLUTION_PATH: Walls32/Walls.sln
  WALLSMAP_SOLUTION_PATH: WallsMap/WallsMap.sln

jobs:
  # ==============================================================================
  # WALLS32 BUILD
  # ==============================================================================
  build-walls:
    runs-on: windows-latest
    strategy:
      matrix:
        configuration: [Release]
        platform: [x86]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fix project paths
        run: |
          # Copy props files to Walls32/ where projects expect them
          Copy-Item -Path "vs_version.props" -Destination "Walls32/vs_version.props"
          Copy-Item -Path "zlib.props" -Destination "Walls32/zlib.props"

          # Copy inc/ and lib/ directories to Walls32/ where vs_version.props expects them
          # (WorkINC=$(SolutionDir)inc, WorkLIB=$(SolutionDir)lib)
          if (Test-Path "inc") {
            Write-Host "Copying inc/ to Walls32/inc/"
            Copy-Item -Path "inc" -Destination "Walls32/inc" -Recurse -Force
          }
          if (Test-Path "lib") {
            Write-Host "Copying lib/ to Walls32/lib/"
            Copy-Item -Path "lib" -Destination "Walls32/lib" -Recurse -Force
          }

          # Copy expatlib to Walls32/ where wallsvg expects it ($(WorkDIR)expatlib_2010-10-10)
          if (Test-Path "expatlib_2010-10-10") {
            Write-Host "Copying expatlib_2010-10-10/ to Walls32/"
            Copy-Item -Path "expatlib_2010-10-10" -Destination "Walls32/expatlib_2010-10-10" -Recurse -Force
          }

          # Copy zlib-1.2.8 to Walls32/ where zlib.props expects it ($(SolutionDir)\zlib-1.2.8)
          if (Test-Path "zlib-1.2.8") {
            Write-Host "Copying zlib-1.2.8/ to Walls32/"
            Copy-Item -Path "zlib-1.2.8" -Destination "Walls32/zlib-1.2.8" -Recurse -Force
          }

          # Checkout is at D:\a\walls\walls\
          # Solution at D:\a\walls\walls\Walls32\Walls.sln references ..\..\lib
          # That resolves to D:\a\walls\lib (one level up from repo)
          $parentDir = Split-Path -Parent (Get-Location)  # D:\a\walls

          # Copy library folders to expected location
          $libs = @("expatlib_2010-10-10", "pcrelib", "gziplib")
          foreach ($lib in $libs) {
            $src = Join-Path (Get-Location) $lib
            $dst = Join-Path $parentDir $lib
            if (Test-Path $src) {
              Write-Host "Copying $lib to $dst"
              Copy-Item -Path $src -Destination $dst -Recurse -Force
            } else {
              Write-Host "Warning: $lib not found in repo"
            }
          }

          # Fix wallgps.vcxproj: update SDK version and toolset for CI build
          $wallgpsPath = "Walls32/wallgps/wallgps.vcxproj"
          $wallgpsXml = Get-Content $wallgpsPath -Raw
          # Change WindowsTargetPlatformVersion from 7.0 to 10.0
          $wallgpsXml = $wallgpsXml -replace '<WindowsTargetPlatformVersion>7\.0</WindowsTargetPlatformVersion>', '<WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>'
          # Change PlatformToolset from v141_xp to v141 for Release|Win32
          $wallgpsXml = $wallgpsXml -replace "(<PropertyGroup Condition=`"'\`$\(Configuration\)\|\`$\(Platform\)'=='Release\|Win32'`" Label=`"Configuration`">[\s\S]*?<PlatformToolset>)v141_xp(</PlatformToolset>)", '$1v141$2'
          Set-Content $wallgpsPath -Value $wallgpsXml -NoNewline
          Write-Host "Fixed wallgps.vcxproj SDK version and toolset"

          # Fix Walls.sln: remove non-existent sefin project and fix config mappings
          $slnPath = "Walls32/Walls.sln"
          $slnContent = Get-Content $slnPath -Raw

          # Remove sefin project (doesn't exist in repo)
          $slnContent = $slnContent -replace 'Project\("\{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942\}"\) = "sefin"[^\r\n]*\r?\nEndProject\r?\n', ''
          $slnContent = $slnContent -replace '\s*\{17D16115-259F-462A-9B4A-4C6F19C09EE6\}[^\r\n]*\r?\n', "`n"

          # Replace Release_XP|Win32 with Release|Win32 for Release|x86 mappings
          $slnContent = $slnContent -replace '(\.Release\|x86\.ActiveCfg = )Release_XP\|Win32', '$1Release|Win32'
          $slnContent = $slnContent -replace '(\.Release\|x86\.Build\.0 = )Release_XP\|Win32', '$1Release|Win32'
          Set-Content $slnPath -Value $slnContent -NoNewline
          Write-Host "Fixed Walls.sln: removed sefin, fixed configuration mappings"

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2

      - name: Install NASM
        run: |
          choco install nasm -y --no-progress
          echo "C:\Program Files\NASM" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify NASM
        run: nasm --version

      - name: Download OpenGL headers
        run: |
          $sdkPath = "C:\Program Files (x86)\Windows Kits\10\Include"
          $sdkDirs = Get-ChildItem -Path $sdkPath -Directory | Sort-Object Name -Descending | Select-Object -First 1
          if ($sdkDirs) {
            $glPath = "$($sdkDirs.FullName)\um\gl"
            $khrPath = "$($sdkDirs.FullName)\um\KHR"

            if (-not (Test-Path $glPath)) {
              New-Item -ItemType Directory -Force -Path $glPath | Out-Null
            }
            if (-not (Test-Path $khrPath)) {
              New-Item -ItemType Directory -Force -Path $khrPath | Out-Null
            }

            Write-Host "Downloading OpenGL headers to $glPath"
            Invoke-WebRequest -Uri "https://www.khronos.org/registry/OpenGL/api/GL/glext.h" -OutFile "$glPath\glext.h"
            Invoke-WebRequest -Uri "https://www.khronos.org/registry/OpenGL/api/GL/wglext.h" -OutFile "$glPath\wglext.h"
            Invoke-WebRequest -Uri "https://www.khronos.org/registry/EGL/api/KHR/khrplatform.h" -OutFile "$khrPath\khrplatform.h"
          }

      - name: Restore NuGet packages
        run: nuget restore ${{ env.SOLUTION_PATH }}
        continue-on-error: true

      - name: Build Walls32
        run: |
          # First pass - builds libraries (may have link errors, that's expected)
          msbuild ${{ env.SOLUTION_PATH }} `
            /p:Configuration=${{ matrix.configuration }} `
            /p:Platform=${{ matrix.platform }} `
            /p:PlatformToolset=v143 `
            /m `
            /verbosity:minimal `
            /p:ContinueOnError=true || true

          # Second pass - now all libs are built, linking should succeed
          msbuild ${{ env.SOLUTION_PATH }} `
            /p:Configuration=${{ matrix.configuration }} `
            /p:Platform=${{ matrix.platform }} `
            /p:PlatformToolset=v143 `
            /m `
            /verbosity:minimal

      - name: Setup installer files
        run: |
          # Copy built files to bin/ at root level (where vdproj expects them)
          New-Item -ItemType Directory -Force -Path "bin" | Out-Null

          # Copy from Walls32/bin to bin/
          if (Test-Path "Walls32/bin") {
            Get-ChildItem -Path "Walls32/bin" -File | Where-Object { $_.Extension -in ".exe", ".dll" } | ForEach-Object {
              Write-Host "Copying $($_.Name) to bin/"
              Copy-Item $_.FullName -Destination "bin/" -Force
            }
          }

          # Copy walls2D.exe from its Release folder
          if (Test-Path "walls2D/Release/walls2D.exe") {
            Write-Host "Copying walls2D.exe to bin/"
            Copy-Item "walls2D/Release/walls2D.exe" -Destination "bin/" -Force
          }

          # Create placeholder documentation files (Help+Manual not available in CI)
          if (-not (Test-Path "bin/Walls_manual.pdf")) {
            Write-Host "Creating placeholder for Walls_manual.pdf"
            "Walls Manual - See https://github.com/wallscavesurvey/walls" | Out-File -FilePath "bin/Walls_manual.pdf" -Encoding utf8
          }
          if (-not (Test-Path "bin/walls32.chm")) {
            Write-Host "Creating placeholder for walls32.chm"
            New-Item -ItemType File -Force -Path "bin/walls32.chm" | Out-Null
          }

          Write-Host "Contents of bin/:"
          Get-ChildItem -Path "bin" | Format-Table Name, Length

      - name: Build Installer
        run: |
          # Install Inno Setup
          choco install innosetup -y --no-progress

          # Build installer using Inno Setup
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "WallsInstaller\walls.iss"

          # Check if installer was created
          if (Test-Path "bin\WallsInstaller.exe") {
            Write-Host "Installer built successfully!"
            Get-Item "bin\WallsInstaller.exe" | Select-Object Name, Length, LastWriteTime
          } else {
            Write-Host "Installer not found, checking for errors..."
            exit 1
          }
        continue-on-error: true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: walls-${{ matrix.configuration }}-${{ matrix.platform }}
          path: |
            Walls32/bin/*.exe
            Walls32/bin/*.dll
            bin/WallsInstaller.exe
          retention-days: 7

  # ==============================================================================
  # WALLSMAP BUILD
  # ==============================================================================
  build-wallsmap:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fix project paths
        run: |
          # Copy props files
          Copy-Item -Path "vs_version.props" -Destination "Walls32/vs_version.props" -ErrorAction SilentlyContinue
          Copy-Item -Path "vs_version.props" -Destination "WallsMap/vs_version.props" -ErrorAction SilentlyContinue
          Copy-Item -Path "zlib.props" -Destination "Walls32/zlib.props" -ErrorAction SilentlyContinue
          Copy-Item -Path "zlib.props" -Destination "WallsMap/zlib.props" -ErrorAction SilentlyContinue

          # Copy inc/ and lib/ to WallsMap/
          if (Test-Path "inc") {
            Copy-Item -Path "inc" -Destination "WallsMap/inc" -Recurse -Force
          }
          if (Test-Path "lib") {
            Copy-Item -Path "lib" -Destination "WallsMap/lib" -Recurse -Force
          }

          # Copy libraries to WallsMap/ where $(WorkDIR) = $(SolutionDir) = WallsMap/
          $wallsMapLibs = @(
            "libjpeg-turbo",
            "libjpegtbo",
            "Serial",
            "libgdal_1110",
            "libpng164",
            "Kakadu6_4",
            "zlib-1.2.8",
            "iqalib",
            "libgeoref",
            "libloco",
            "dbf_file"
          )
          foreach ($lib in $wallsMapLibs) {
            if (Test-Path $lib) {
              Write-Host "Copying $lib to WallsMap/$lib"
              Copy-Item -Path $lib -Destination "WallsMap/$lib" -Recurse -Force
            }
          }

          # Checkout is at D:\a\walls\walls\
          # WallsMap.sln references ..\..\ paths for many libraries
          # That resolves to D:\a\walls\ (one level up from repo)
          $parentDir = Split-Path -Parent (Get-Location)

          # Copy all external libraries to parent directory
          $libs = @(
            "expatlib_2010-10-10",
            "pcrelib",
            "gziplib",
            "zlib-1.2.8",
            "Kakadu6_4",
            "ECW_3.3",
            "iqalib",
            "libgdal_1110",
            "libpng164",
            "libjpegtbo",
            "libwebp",
            "libgeoref",
            "libloco",
            "dbf_file"
          )
          foreach ($lib in $libs) {
            $src = Join-Path (Get-Location) $lib
            $dst = Join-Path $parentDir $lib
            if (Test-Path $src) {
              Write-Host "Copying $lib to $dst"
              Copy-Item -Path $src -Destination $dst -Recurse -Force
            } else {
              Write-Host "Warning: $lib not found in repo"
            }
          }

          # Remove missing projects from solution (don't exist in repo)
          $slnPath = "WallsMap/WallsMap.sln"
          $content = Get-Content $slnPath -Raw

          # Remove SampleSpellingClient project (EndProject is on separate line)
          $content = $content -replace 'Project\("\{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942\}"\) = "SampleSpellingClient"[^\r\n]*\r?\nEndProject\r?\n', ''
          $content = $content -replace '\s*\{6D04155E-C3D9-4CB6-BCFD-2B5A205C0329\}[^\r\n]*\r?\n', "`n"

          # Remove webpc project (not in repo)
          $content = $content -replace 'Project\("\{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942\}"\) = "webpc"[^\r\n]*\r?\nEndProject\r?\n', ''
          $content = $content -replace '\s*\{7B365444-F5F6-4347-AE6E-11BA9C374FFC\}[^\r\n]*\r?\n', "`n"

          # Remove webpd project (not in repo)
          $content = $content -replace 'Project\("\{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942\}"\) = "webpd"[^\r\n]*\r?\nEndProject\r?\n', ''
          $content = $content -replace '\s*\{A7CC633C-905E-4DE7-9EBE-FA3FAAF1FF1B\}[^\r\n]*\r?\n', "`n"

          Set-Content $slnPath -Value $content -NoNewline
          Write-Host "Removed missing projects from WallsMap.sln"

          # Add Build.0 entries for libgeoref and iqalib for Release|Mixed Platforms
          # These projects have ActiveCfg but missing Build.0 entries
          $slnContent = Get-Content $slnPath -Raw

          # Add Build.0 for libgeoref (GUID: 51964B44-58AA-4FBA-99B7-539104B81F85)
          $slnContent = $slnContent -replace '(\{51964B44-58AA-4FBA-99B7-539104B81F85\}\.Release\|Mixed Platforms\.ActiveCfg = Release\|Win32)', "`$1`r`n`t`t{51964B44-58AA-4FBA-99B7-539104B81F85}.Release|Mixed Platforms.Build.0 = Release|Win32"

          # Add Build.0 for iqalib (GUID: 3C7BB421-C147-4828-8EAE-53A5F1A0394A)
          $slnContent = $slnContent -replace '(\{3C7BB421-C147-4828-8EAE-53A5F1A0394A\}\.Release\|Mixed Platforms\.ActiveCfg = Release\|Win32)', "`$1`r`n`t`t{3C7BB421-C147-4828-8EAE-53A5F1A0394A}.Release|Mixed Platforms.Build.0 = Release|Win32"

          # Add Build.0 for libloco (GUID: C01FAD87-CF2D-4336-AAF5-3F6DD4E9D593)
          $slnContent = $slnContent -replace '(\{C01FAD87-CF2D-4336-AAF5-3F6DD4E9D593\}\.Release\|Mixed Platforms\.ActiveCfg = Release\|Win32)', "`$1`r`n`t`t{C01FAD87-CF2D-4336-AAF5-3F6DD4E9D593}.Release|Mixed Platforms.Build.0 = Release|Win32"

          # Add Build.0 for dbf_file (GUID: 3F61C2DA-FAB7-477B-96A6-5CF2D786C56D)
          $slnContent = $slnContent -replace '(\{3F61C2DA-FAB7-477B-96A6-5CF2D786C56D\}\.Release\|Mixed Platforms\.ActiveCfg = Release\|Win32)', "`$1`r`n`t`t{3F61C2DA-FAB7-477B-96A6-5CF2D786C56D}.Release|Mixed Platforms.Build.0 = Release|Win32"

          # Add Build.0 for libgdal_1110 (GUID: 07246777-7600-4117-8F4E-F3592AAC97D1)
          $slnContent = $slnContent -replace '(\{07246777-7600-4117-8F4E-F3592AAC97D1\}\.Release\|Mixed Platforms\.ActiveCfg = Release\|Win32)', "`$1`r`n`t`t{07246777-7600-4117-8F4E-F3592AAC97D1}.Release|Mixed Platforms.Build.0 = Release|Win32"

          # Add Build.0 for dbfv (GUID: 43E22DD8-63D1-444A-82C5-5DFA0443A7B7)
          $slnContent = $slnContent -replace '(\{43E22DD8-63D1-444A-82C5-5DFA0443A7B7\}\.Release\|Mixed Platforms\.ActiveCfg = Release\|Win32)', "`$1`r`n`t`t{43E22DD8-63D1-444A-82C5-5DFA0443A7B7}.Release|Mixed Platforms.Build.0 = Release|Win32"

          # Add Build.0 for Kakadu6_4 (GUID: F1CFE0F2-72DA-464C-B752-38A198476012)
          $slnContent = $slnContent -replace '(\{F1CFE0F2-72DA-464C-B752-38A198476012\}\.Release\|Mixed Platforms\.ActiveCfg = Release\|Win32)', "`$1`r`n`t`t{F1CFE0F2-72DA-464C-B752-38A198476012}.Release|Mixed Platforms.Build.0 = Release|Win32"

          # Add Build.0 for libecwj2S (GUID: A6103D1E-3E79-33F6-A4C9-19CE5E183F65)
          $slnContent = $slnContent -replace '(\{A6103D1E-3E79-33F6-A4C9-19CE5E183F65\}\.Release\|Mixed Platforms\.ActiveCfg = Release\|Win32)', "`$1`r`n`t`t{A6103D1E-3E79-33F6-A4C9-19CE5E183F65}.Release|Mixed Platforms.Build.0 = Release|Win32"

          # Add Build.0 for libwebp (GUID: E55DDD38-D597-4AF4-8C2C-94D84DE6A9AB)
          $slnContent = $slnContent -replace '(\{E55DDD38-D597-4AF4-8C2C-94D84DE6A9AB\}\.Release\|Mixed Platforms\.ActiveCfg = Release\|Win32)', "`$1`r`n`t`t{E55DDD38-D597-4AF4-8C2C-94D84DE6A9AB}.Release|Mixed Platforms.Build.0 = Release|Win32"

          # Add Build.0 for dbf-filter (GUID: DC33E275-BBFF-4E22-B082-B613DBA3991F)
          $slnContent = $slnContent -replace '(\{DC33E275-BBFF-4E22-B082-B613DBA3991F\}\.Release\|Mixed Platforms\.ActiveCfg = Release\|Win32)', "`$1`r`n`t`t{DC33E275-BBFF-4E22-B082-B613DBA3991F}.Release|Mixed Platforms.Build.0 = Release|Win32"

          # Add Build.0 for libpng164 (GUID: E07A7B76-08BA-430B-B1AA-883F75DE2379)
          $slnContent = $slnContent -replace '(\{E07A7B76-08BA-430B-B1AA-883F75DE2379\}\.Release\|Mixed Platforms\.ActiveCfg = Release\|Win32)', "`$1`r`n`t`t{E07A7B76-08BA-430B-B1AA-883F75DE2379}.Release|Mixed Platforms.Build.0 = Release|Win32"

          Set-Content $slnPath -Value $slnContent -NoNewline
          Write-Host "Added Build.0 entries for libgeoref and iqalib"

          # Fix UpdateTSS Windows SDK version from 8.1 to 10.0
          $updateTssPath = "UpdateTSS/UpdateTSS.vcxproj"
          if (Test-Path $updateTssPath) {
            $updateTssXml = Get-Content $updateTssPath -Raw
            $updateTssXml = $updateTssXml -replace '<WindowsTargetPlatformVersion>8\.1</WindowsTargetPlatformVersion>', '<WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>'
            Set-Content $updateTssPath -Value $updateTssXml -NoNewline
            Write-Host "Fixed UpdateTSS Windows SDK version to 10.0"
          }

          # Fix arc_date.c: timezone -> _timezone for MSVC compatibility
          $arcDatePath = "dbf_file/dbfv/arc_date.c"
          if (Test-Path $arcDatePath) {
            $arcDateContent = Get-Content $arcDatePath -Raw
            $arcDateContent = $arcDateContent -replace '\+timezone;', '+_timezone;'
            Set-Content $arcDatePath -Value $arcDateContent -NoNewline
            Write-Host "Fixed arc_date.c timezone -> _timezone"
          }

          # Fix libjpegtbo CMake custom build issues
          # Create stamp file so CMake custom builds think they're up-to-date
          $stampDir = "WallsMap/libjpegtbo/CMakeFiles"
          if (-not (Test-Path $stampDir)) {
            New-Item -ItemType Directory -Force -Path $stampDir | Out-Null
          }
          "stamp" | Out-File -FilePath "$stampDir/generate.stamp" -Encoding ascii

          # Create the stamp rule file that ZERO_CHECK looks for
          $stampRuleDir = "WallsMap/libjpegtbo/CMakeFiles/1596c735aba799af362fbf67e22d12e2"
          if (-not (Test-Path $stampRuleDir)) {
            New-Item -ItemType Directory -Force -Path $stampRuleDir | Out-Null
          }
          "stamp" | Out-File -FilePath "$stampRuleDir/generate.stamp.rule" -Encoding ascii

          # Also create in parent dir location (for ..\..\libjpegtbo references)
          $parentStampDir = Join-Path $parentDir "libjpegtbo/CMakeFiles"
          if (-not (Test-Path $parentStampDir)) {
            New-Item -ItemType Directory -Force -Path $parentStampDir | Out-Null
          }
          "stamp" | Out-File -FilePath "$parentStampDir/generate.stamp" -Encoding ascii

          $parentStampRuleDir = Join-Path $parentDir "libjpegtbo/CMakeFiles/1596c735aba799af362fbf67e22d12e2"
          if (-not (Test-Path $parentStampRuleDir)) {
            New-Item -ItemType Directory -Force -Path $parentStampRuleDir | Out-Null
          }
          "stamp" | Out-File -FilePath "$parentStampRuleDir/generate.stamp.rule" -Encoding ascii

          # Remove CustomBuild sections from libjpegtbo vcxproj files to skip CMake calls
          $vcxprojFiles = @(
            "WallsMap/libjpegtbo/jpeg-static.vcxproj",
            "WallsMap/libjpegtbo/turbojpeg-static.vcxproj",
            "WallsMap/libjpegtbo/simd/simd.vcxproj",
            "WallsMap/libjpegtbo/ZERO_CHECK.vcxproj",
            (Join-Path $parentDir "libjpegtbo/jpeg-static.vcxproj"),
            (Join-Path $parentDir "libjpegtbo/turbojpeg-static.vcxproj"),
            (Join-Path $parentDir "libjpegtbo/simd/simd.vcxproj"),
            (Join-Path $parentDir "libjpegtbo/ZERO_CHECK.vcxproj")
          )
          foreach ($vcxproj in $vcxprojFiles) {
            if (Test-Path $vcxproj) {
              Write-Host "Removing CustomBuild from $vcxproj"
              $xml = Get-Content $vcxproj -Raw
              # Remove entire ItemGroup containing CustomBuild for CMakeLists.txt
              $xml = $xml -replace '(?s)<ItemGroup>\s*<CustomBuild Include="[^"]*CMakeLists\.txt"[^>]*>.*?</CustomBuild>\s*</ItemGroup>', ''
              # Remove ItemGroup with generate.stamp.rule
              $xml = $xml -replace '(?s)<ItemGroup>\s*<CustomBuild Include="[^"]*generate\.stamp\.rule"[^>]*>.*?</CustomBuild>\s*</ItemGroup>', ''
              Set-Content $vcxproj -Value $xml -NoNewline
            }
          }

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2

      - name: Install NASM
        run: |
          choco install nasm -y --no-progress
          echo "C:\Program Files\NASM" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Download OpenGL headers
        run: |
          $sdkPath = "C:\Program Files (x86)\Windows Kits\10\Include"
          $sdkDirs = Get-ChildItem -Path $sdkPath -Directory | Sort-Object Name -Descending | Select-Object -First 1
          if ($sdkDirs) {
            $glPath = "$($sdkDirs.FullName)\um\gl"
            $khrPath = "$($sdkDirs.FullName)\um\KHR"

            if (-not (Test-Path $glPath)) {
              New-Item -ItemType Directory -Force -Path $glPath | Out-Null
            }
            if (-not (Test-Path $khrPath)) {
              New-Item -ItemType Directory -Force -Path $khrPath | Out-Null
            }

            Invoke-WebRequest -Uri "https://www.khronos.org/registry/OpenGL/api/GL/glext.h" -OutFile "$glPath\glext.h"
            Invoke-WebRequest -Uri "https://www.khronos.org/registry/OpenGL/api/GL/wglext.h" -OutFile "$glPath\wglext.h"
            Invoke-WebRequest -Uri "https://www.khronos.org/registry/EGL/api/KHR/khrplatform.h" -OutFile "$khrPath\khrplatform.h"
          }

      - name: Restore NuGet packages
        run: nuget restore ${{ env.WALLSMAP_SOLUTION_PATH }}
        continue-on-error: true

      - name: Build WallsMap
        run: |
          # Use "Mixed Platforms" because the solution file only has Build.0 entries
          # for WallsMap and most other projects under "Mixed Platforms", not "Win32"

          # First pass - builds libraries (may have link errors, that's expected)
          msbuild ${{ env.WALLSMAP_SOLUTION_PATH }} `
            /p:Configuration=Release `
            "/p:Platform=Mixed Platforms" `
            /p:PlatformToolset=v143 `
            /m `
            /verbosity:minimal `
            /p:ContinueOnError=true || true

          # Second pass - now all libs are built, linking should succeed
          msbuild ${{ env.WALLSMAP_SOLUTION_PATH }} `
            /p:Configuration=Release `
            "/p:Platform=Mixed Platforms" `
            /p:PlatformToolset=v143 `
            /m `
            /verbosity:minimal

      - name: List build output
        run: |
          Write-Host "=== WallsMap/Release ==="
          if (Test-Path "WallsMap/Release") {
            Get-ChildItem -Path "WallsMap/Release" -Recurse | Where-Object { $_.Extension -in ".exe", ".dll" } | ForEach-Object {
              Write-Host "$($_.FullName) - $($_.Length) bytes"
            }
          } else {
            Write-Host "Directory WallsMap/Release does not exist"
          }
          Write-Host "=== Looking for WallsMap.exe anywhere ==="
          Get-ChildItem -Path "." -Recurse -Filter "WallsMap.exe" -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "$($_.FullName) - $($_.Length) bytes"
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wallsmap-release-x86
          path: |
            WallsMap/Release/*.exe
            WallsMap/Release/*.dll
          retention-days: 7

  # ==============================================================================
  # RELEASE (on tags)
  # ==============================================================================
  release:
    runs-on: windows-latest
    needs: [build-walls, build-wallsmap]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download Walls artifacts
        uses: actions/download-artifact@v4
        with:
          name: walls-Release-x86
          path: release-files/walls

      - name: Download WallsMap artifacts
        uses: actions/download-artifact@v4
        with:
          name: wallsmap-release-x86
          path: release-files/wallsmap
        continue-on-error: true

      - name: Create release archive
        run: |
          $tag = "${{ github.ref_name }}"
          Compress-Archive -Path "release-files/*" -DestinationPath "Walls-$tag.zip"

          # Also prepare installer as standalone download if it exists
          $installerPath = Get-ChildItem -Path "release-files" -Filter "*.msi" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($installerPath) {
            Copy-Item $installerPath.FullName -Destination "WallsInstaller-$tag.msi"
          }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Walls-*.zip
            WallsInstaller-*.msi
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
